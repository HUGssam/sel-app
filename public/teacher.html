<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>사회정서학습(SEL) 진단 결과 - 교사용</title>
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
    rel="stylesheet"
  />
  <style>
    body { background: #f8f9fa; }
    .container { max-width: 1200px; }
  </style>
</head>
<body>
  <div class="container py-4">
    <h2 class="mb-4 fw-bold">사회정서학습(SEL) 진단 결과 - 교사용</h2>

    <!-- 검색 영역 -->
    <div class="row mb-4">
      <div class="col-md-3">
        <label class="form-label">학년 그룹</label>
        <select id="gradeGroup" class="form-select">
          <option value="">전체</option>
          <option value="12">1-2학년</option>
          <option value="34">3-4학년</option>
          <option value="56">5-6학년</option>
        </select>
      </div>

      <div class="col-md-4">
        <label class="form-label">반/번호(코드)</label>
        <input id="studentCode" class="form-control" placeholder="예: 3-1-02" />
      </div>

      <div class="col-md-5 d-flex align-items-end">
        <button id="searchBtn" class="btn btn-primary me-2" style="width: 120px;">조회</button>
        <button id="resetBtn"  class="btn btn-outline-secondary me-2" style="width: 120px;">초기화</button>
        <button id="exportExcel" class="btn btn-success" style="width: 160px;">엑셀 전체 저장</button>
      </div>
    </div>

    <h4 class="fw-bold mt-4">2. 결과 목록</h4>
    <p>총 <span id="totalCount">0</span>건의 결과가 있습니다.</p>

    <div class="table-responsive">
      <table class="table table-bordered table-hover align-middle bg-white">
        <thead class="table-primary">
          <tr>
            <th>ID</th>
            <th>코드</th>
            <th>학년그룹</th>
            <th>종신호등</th>
            <th>요약 정보 (자동 생성)</th>
            <th>응시시간</th>
          </tr>
        </thead>
        <tbody id="resultBody"></tbody>
      </table>
    </div>
  </div>

  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const gradeSel   = document.getElementById("gradeGroup");
      const codeInput  = document.getElementById("studentCode");
      const searchBtn  = document.getElementById("searchBtn");
      const resetBtn   = document.getElementById("resetBtn");
      const exportBtn  = document.getElementById("exportExcel");
      const resultBody = document.getElementById("resultBody");
      const totalCount = document.getElementById("totalCount");

      // 학생별 자동 요약 생성
      function makeSummary(row) {
        if (!row.domainLevels) return "요약 정보 없음";

        const good = [];
        const need = [];

        for (const [name, level] of Object.entries(row.domainLevels)) {
          if (level === "green")  good.push(name);
          if (level === "yellow" || level === "red") need.push(name);
        }

        let text = "";
        if (good.length > 0) {
          text += `잘하고 있는 역량: ${good.join(", ")}. `;
        }
        if (need.length > 0) {
          text += `보완이 필요한 역량: ${need.join(", ")}.`;
        }
        return text || "요약 정보 없음";
      }

      // 결과 불러오기
      async function loadResults() {
        const params = new URLSearchParams();
        if (gradeSel.value) params.append("gradeGroup", gradeSel.value);
        if (codeInput.value.trim())
          params.append("studentCode", codeInput.value.trim());

        try {
          const res = await fetch(`/api/sel/results?${params.toString()}`);
          if (!res.ok) {
            alert("결과를 불러오는 중 오류가 발생했습니다.");
            return;
          }
          const data = await res.json();
          renderTable(data);
        } catch (err) {
          console.error(err);
          alert("조회 실패");
        }
      }

      // 표 렌더링
      function renderTable(list) {
        resultBody.innerHTML = "";
        totalCount.textContent = list.length;

        list.forEach((row) => {
          const tr = document.createElement("tr");
          const created = row.createdAt
            ? new Date(row.createdAt).toLocaleString("ko-KR")
            : "";

          tr.innerHTML = `
            <td>${row.id}</td>
            <td>${row.studentCode}</td>
            <td>${row.gradeGroup}</td>
            <td>${row.overallLevel || ""}</td>
            <td>${makeSummary(row)}</td>
            <td>${created}</td>
          `;
          resultBody.appendChild(tr);
        });
      }

      // 버튼 연결
      searchBtn.addEventListener("click", loadResults);

      resetBtn.addEventListener("click", () => {
        gradeSel.value = "";
        codeInput.value = "";
        loadResults();   // 전체 다시 불러오기
      });

      exportBtn.addEventListener("click", () => {
        // 서버에서 엑셀 파일 생성 후 다운로드
        window.location.href = "/api/sel/export";
      });

      // 처음 들어왔을 때 전체 조회
      loadResults();
    });
  </script>
</body>
</html>
