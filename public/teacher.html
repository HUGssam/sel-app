<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>ì‚¬íšŒì •ì„œí•™ìŠµ(SEL) ì§„ë‹¨ ê²°ê³¼ - êµì‚¬ìš©</title>
  <style>
    body {
      font-family: "Noto Sans KR", sans-serif;
      background: #f5f5f5;
      padding: 20px;
    }
    h1 {
      color: #333;
    }
    .box {
      background: white;
      padding: 20px;
      margin-top: 20px;
      border-radius: 10px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 15px;
    }
    th, td {
      border: 1px solid #ddd;
      padding: 8px;
      text-align: center;
    }
    th {
      background: #345beb;
      color: white;
    }
    .btn {
      background: #345beb;
      color: white;
      border: none;
      padding: 8px 14px;
      border-radius: 6px;
      cursor: pointer;
      margin-left: 10px;
    }
  </style>
</head>

<body>
  <h1>ì‚¬íšŒì •ì„œí•™ìŠµ(SEL) ì§„ë‹¨ ê²°ê³¼ - êµì‚¬ìš©</h1>

  <div class="box">
    <h2>1. ì¡°íšŒ ì¡°ê±´</h2>

    <label>í•™ë…„ ê·¸ë£¹</label>
    <select id="gradeGroup">
      <option value="">ì „ì²´</option>
      <option value="34">3Â·4í•™ë…„</option>
      <option value="56">5Â·6í•™ë…„</option>
    </select>

    <label style="margin-left:20px;">ë°˜/ë²ˆí˜¸(ì½”ë“œ):</label>
    <input id="studentCode" placeholder="ì˜ˆ: 3-2 ë˜ëŠ” 5-1-02" />

    <button class="btn" onclick="loadResults()">ì¡°íšŒ</button>
    <button class="btn" onclick="resetFilters()">ì´ˆê¸°í™”</button>
    <button class="btn" onclick="downloadCSV()">ì—‘ì…€ ë‹¤ìš´ë¡œë“œ</button>
  </div>

  <div class="box">
    <h2>2. ê²°ê³¼ ëª©ë¡</h2>
    <p id="countText">ì´ 0ê±´ì˜ ê²°ê³¼ê°€ ìˆìŠµë‹ˆë‹¤.</p>

    <table id="resultTable">
      <thead>
        <tr>
          <th>ID</th>
          <th>ì½”ë“œ</th>
          <th>í•™ë…„ê·¸ë£¹</th>
          <th>ì´ì‹ í˜¸ë“±</th>
          <th>ì„¸ë¶€ì •ë³´</th>
          <th>ì‘ì‹œì‹œê°„</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <script>
    let autoRefreshTimer = null;

    async function loadResults() {
      const gradeGroup = document.getElementById("gradeGroup").value;
      const studentCode = document.getElementById("studentCode").value.trim();

      const params = new URLSearchParams();
      if (gradeGroup) params.append("gradeGroup", gradeGroup);
      if (studentCode) params.append("studentCode", studentCode);

      const res = await fetch(`/api/sel/results?${params.toString()}`);
      const data = await res.json();

      const tbody = document.querySelector("#resultTable tbody");
      tbody.innerHTML = "";

      data.forEach((r) => {
        const tr = document.createElement("tr");

        const detail = parseDetail(r.domain_levels || r.domainLevels);
        const timeText = r.created_at
          ? new Date(r.created_at).toLocaleString("ko-KR")
          : "";

        tr.innerHTML = `
          <td>${r.id}</td>
          <td>${r.student_code || r.studentCode}</td>
          <td>${r.grade_group || r.gradeGroup}</td>
          <td>${r.overall_level || r.overallLevel || ""}</td>
          <td>${detail}</td>
          <td>${timeText}</td>
        `;
        tbody.appendChild(tr);
      });

      document.getElementById("countText").innerText =
        `ì´ ${data.length}ê±´ì˜ ê²°ê³¼ê°€ ìˆìŠµë‹ˆë‹¤.`;
    }

    function parseDetail(raw) {
      if (!raw) return "";
      try {
        const obj = typeof raw === "string" ? JSON.parse(raw) : raw;
        return Object.entries(obj)
          .map(([k, v]) => `${k}:${v}`)
          .join(", ");
      } catch {
        return raw;
      }
    }

    function resetFilters() {
      document.getElementById("gradeGroup").value = "";
      document.getElementById("studentCode").value = "";
      loadResults();
    }

    // ===============================
    // ğŸ”¥ CSV ë‹¤ìš´ë¡œë“œ (ì—‘ì…€ ë‚ ì§œ ë³€í™˜ ë°©ì§€ í¬í•¨)
    // ===============================
    async function downloadCSV() {
      const gradeGroup = document.getElementById("gradeGroup").value;
      const studentCode = document.getElementById("studentCode").value.trim();

      const params = new URLSearchParams();
      if (gradeGroup) params.append("gradeGroup", gradeGroup);
      if (studentCode) params.append("studentCode", studentCode);

      const res = await fetch(`/api/sel/results?${params.toString()}`);
      const data = await res.json();

      const rows = data.map((r) => {
        const detail = parseDetail(r.domain_levels || r.domainLevels);

        // ğŸ”¹ ì½”ë“œê°€ ë‚ ì§œë¡œ ë³€í™˜ë˜ì§€ ì•Šë„ë¡ Excel ë³´í˜¸ í˜•ì‹ ì ìš©
        const codeValue = r.student_code || r.studentCode || "";
        const safeCode = `="${String(codeValue).replace(/"/g, '""')}"`;

        const created = r.created_at || r.createdAt;
        const timeText = created
          ? new Date(created).toLocaleString("ko-KR")
          : "";

        return [
          r.id,
          safeCode,          // â† ì—‘ì…€ ìë™ ë‚ ì§œ ë³€í™˜ ë°©ì§€
          r.grade_group || r.gradeGroup,
          r.overall_level || r.overallLevel || "",
          detail,
          timeText
        ];
      });

      const csvLines = [
        ["ID", "ì½”ë“œ", "í•™ë…„ê·¸ë£¹", "ì´ì‹ í˜¸ë“±", "ì„¸ë¶€ì •ë³´", "ì‘ì‹œì‹œê°„"],
        ...rows
      ]
        .map((row) => row.join(","))
        .join("\n");

      const blob = new Blob([csvLines], { type: "text/csv;charset=utf-8;" });
      const link = document.createElement("a");
      link.href = URL.createObjectURL(blob);
      link.download = `sel_results_${new Date().toISOString().slice(0, 10)}.csv`;
      link.click();
    }

    // ===============================
    // ğŸ”„ ìë™ ìƒˆë¡œê³ ì¹¨ (5ì´ˆ)
    // ===============================
    function startAutoRefresh() {
      if (autoRefreshTimer) clearInterval(autoRefreshTimer);
      autoRefreshTimer = setInterval(loadResults, 5000);
    }

    loadResults();
    startAutoRefresh();
  </script>
</body>
</html>
