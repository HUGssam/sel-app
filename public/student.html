<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>사회정서학습(SEL) 진단 - 학생용</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 0;
      padding: 0;
      background: #f5f7fb;
      color: #111827;
    }

    header {
      background: #2563eb;
      color: white;
      padding: 16px 20px;
    }

    header h1 {
      margin: 0;
      font-size: 20px;
    }

    main {
      max-width: 900px;
      margin: 0 auto;
      padding: 20px 16px 40px;
    }

    .card {
      background: white;
      border-radius: 12px;
      box-shadow: 0 2px 6px rgba(15, 23, 42, 0.08);
      padding: 16px 18px 20px;
      margin-bottom: 18px;
    }

    .card h2 {
      margin: 0 0 10px;
      font-size: 18px;
    }

    .field-row {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-bottom: 10px;
      align-items: center;
    }

    label {
      font-size: 14px;
    }

    select, input[type="text"] {
      padding: 6px 10px;
      border-radius: 8px;
      border: 1px solid #d1d5db;
      font-size: 14px;
    }

    .question {
      margin-bottom: 16px;
      padding: 10px 10px 12px;
      border-radius: 10px;
      background: #f9fafb;
    }

    .question-title {
      font-size: 14px;
      margin-bottom: 8px;
    }

    .options {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }

    .option {
      display: flex;
      align-items: center;
      gap: 4px;
      font-size: 13px;
      padding: 4px 8px;
      border-radius: 999px;
      border: 1px solid #d1d5db;
      background: white;
      cursor: pointer;
    }

    .option input {
      accent-color: #2563eb;
    }

    button {
      border-radius: 999px;
      border: none;
      padding: 8px 16px;
      font-size: 14px;
      cursor: pointer;
    }

    .btn-primary {
      background: #2563eb;
      color: white;
    }

    .btn-secondary {
      background: white;
      color: #2563eb;
      border: 1px solid #2563eb;
    }

    .result-box {
      margin-top: 10px;
      padding: 10px;
      background: #f9fafb;
      border-radius: 8px;
      font-size: 14px;
      line-height: 1.5;
    }

    .pill {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 12px;
      margin-right: 4px;
    }

    .pill.green { background:#dcfce7; color:#15803d; }
    .pill.yellow { background:#fef9c3; color:#a16207; }
    .pill.red { background:#fee2e2; color:#b91c1c; }

    .hidden { display: none; }

    @media (max-width: 640px) {
      header h1 { font-size: 18px; }
    }
  </style>
</head>
<body>
<header>
  <h1>사회정서학습(SEL) 진단 - 학생용</h1>
</header>

<main>
  <!-- 1. 기본 정보 -->
  <section class="card">
    <h2>1. 기본 정보</h2>
    <div class="field-row">
      <label for="gradeGroup">학년 그룹</label>
      <select id="gradeGroup">
        <option value="34">3-4학년</option>
        <option value="56">5-6학년</option>
      </select>
    </div>
    <div class="field-row">
      <label for="studentCode">반/번호(코드)</label>
      <input id="studentCode" type="text" placeholder="예: 3-1-02" />
    </div>
    <p style="font-size:13px; color:#6b7280; margin-top:4px;">
      * 이름 대신 쓸 코드입니다. 예) 3학년 1반 2번 → <strong>3-1-02</strong>
    </p>
  </section>

  <!-- 2. 문항 영역 -->
  <section class="card">
    <h2>2. 질문에 답해 주세요</h2>
    <p style="font-size:13px; color:#4b5563; margin-top:0; margin-bottom:10px;">
      아래 문장을 읽고, 요즘의 나와 가장 비슷한 정도를 골라 주세요.
      <br />
      <strong>전혀 그렇지 않다 / 가끔 그렇다 / 자주 그렇다 / 항상 그렇다</strong>
    </p>
    <div id="questionContainer"></div>
    <button class="btn-primary" id="submitBtn">완료</button>
    <button class="btn-secondary" id="resetBtn" style="margin-left:6px;">처음부터 다시</button>
  </section>

  <!-- 3. 결과 -->
  <section class="card hidden" id="resultSection">
    <h2>3. 오늘의 SEL 결과</h2>
    <div id="resultContent" class="result-box"></div>
  </section>
</main>

<script>
  // ------------------------
  // 1. 문항 정의
  // ------------------------

  // 3–4학년용 (12문항) : 자기 인식 / 자기 관리 중심
  const QUESTIONS_34 = [
    { id: 1,  text: '나는 요즘 내 기분이 어떤지 스스로 잘 알고 있다.', domain: 'selfAwareness' },
    { id: 2,  text: '나는 슬프거나 화날 때, 그 감정을 말로 표현할 수 있다.', domain: 'selfAwareness' },
    { id: 3,  text: '나는 힘들 때 나를 도와줄 사람을 떠올릴 수 있다.', domain: 'selfAwareness' },
    { id: 4,  text: '나는 속상해도 조금 지나면 스스로 진정하려고 노력한다.', domain: 'selfManagement' },
    { id: 5,  text: '나는 하기 싫어도 해야 할 일을 끝까지 하려고 한다.', domain: 'selfManagement' },
    { id: 6,  text: '나는 할 일을 미루지 않으려고 계획을 세운다.', domain: 'selfManagement' },
    { id: 7,  text: '나는 다른 사람의 감정을 상상해 보려고 한다.', domain: 'socialAwareness' },
    { id: 8,  text: '나는 친구에게 먼저 다가가 말을 걸 수 있다.', domain: 'relationshipSkills' },
    { id: 9,  text: '나는 친구와 다툰 뒤 먼저 사과하거나 이야기를 나누려고 한다.', domain: 'relationshipSkills' },
    { id: 10, text: '나는 우리가 함께 지켜야 할 약속(규칙)을 중요하게 생각한다.', domain: 'responsibleDecision' },
    { id: 11, text: '나는 잘못했을 때 솔직하게 인정하려고 한다.', domain: 'responsibleDecision' },
    { id: 12, text: '나는 내 행동이 다른 사람에게 어떤 영향을 주는지 생각해 본다.', domain: 'responsibleDecision' }
  ];

  // 5–6학년용 (15문항) : 5역량 모두 다룸
  const QUESTIONS_56 = [
    { id: 1,  text: '나는 요즘 내 마음과 몸 상태를 스스로 점검하는 편이다.', domain: 'selfAwareness' },
    { id: 2,  text: '나는 한 가지 감정 안에 여러 감정이 섞여 있을 수 있음을 안다.', domain: 'selfAwareness' },
    { id: 3,  text: '나는 불편한 감정을 느낄 때 그 이유를 떠올려 본다.', domain: 'selfAwareness' },
    { id: 4,  text: '나는 힘들어도 해야 할 일을 스스로 계획하고 실천하려 한다.', domain: 'selfManagement' },
    { id: 5,  text: '나는 화가 날 때 나를 진정시키는 나만의 방법(호흡, 쉬기 등)을 사용한다.', domain: 'selfManagement' },
    { id: 6,  text: '나는 긴장되거나 걱정될 때 나를 격려하는 말을 스스로에게 해 준다.', domain: 'selfManagement' },
    { id: 7,  text: '나는 친구나 가족의 입장에서 상황을 보려고 노력한다.', domain: 'socialAwareness' },
    { id: 8,  text: '나는 나와 다른 생각이나 문화도 존중하려고 한다.', domain: 'socialAwareness' },
    { id: 9,  text: '나는 모둠 활동에서 다른 친구의 의견도 듣고 조율하려 한다.', domain: 'relationshipSkills' },
    { id: 10, text: '나는 갈등이 생겼을 때 서로의 입장을 듣고 해결책을 찾으려고 한다.', domain: 'relationshipSkills' },
    { id: 11, text: '나는 선택을 하기 전에 결과가 나와 다른 사람에게 미칠 영향을 생각해 본다.', domain: 'responsibleDecision' },
    { id: 12, text: '나는 잘못된 행동을 권유받았을 때 거절할 줄 안다.', domain: 'responsibleDecision' },
    { id: 13, text: '나는 나와 친구 모두에게 도움이 되는 선택을 찾으려고 한다.', domain: 'responsibleDecision' },
    { id: 14, text: '나는 어려움이 있을 때 주변에 적절한 도움을 요청할 수 있다.', domain: 'relationshipSkills' },
    { id: 15, text: '나는 우리 반/학교 공동체를 위해 내가 할 수 있는 일을 생각해 본다.', domain: 'socialAwareness' }
  ];

  const SCALE_OPTIONS = [
    { value: 1, label: '전혀 그렇지 않다' },
    { value: 2, label: '가끔 그렇다' },
    { value: 3, label: '자주 그렇다' },
    { value: 4, label: '항상 그렇다' }
  ];

  // ------------------------
  // 2. 문항 렌더링
  // ------------------------
  const questionContainer = document.getElementById('questionContainer');
  const gradeSelect = document.getElementById('gradeGroup');

  function renderQuestions() {
    questionContainer.innerHTML = '';
    const grade = gradeSelect.value;
    const questions = grade === '34' ? QUESTIONS_34 : QUESTIONS_56;

    questions.forEach((q) => {
      const div = document.createElement('div');
      div.className = 'question';
      div.innerHTML = `
        <div class="question-title">Q${q.id}. ${q.text}</div>
        <div class="options" data-qid="${q.id}">
        </div>
      `;
      const optionsDiv = div.querySelector('.options');
      SCALE_OPTIONS.forEach((opt) => {
        const label = document.createElement('label');
        label.className = 'option';
        label.innerHTML = `
          <input type="radio" name="q${q.id}" value="${opt.value}" />
          <span>${opt.label}</span>
        `;
        optionsDiv.appendChild(label);
      });
      questionContainer.appendChild(div);
    });
  }

  gradeSelect.addEventListener('change', () => {
    renderQuestions();
    document.getElementById('resultSection').classList.add('hidden');
  });

  renderQuestions(); // 초기 렌더링

  // ------------------------
  // 3. 채점(내부용) + 신호등 계산
  // ------------------------
  function calcLevels(grade, answers, questions) {
    // domain별 평균 계산
    const domainScores = {};
    const domainCounts = {};

    questions.forEach((q, idx) => {
      const v = answers[idx];
      if (!domainScores[q.domain]) {
        domainScores[q.domain] = 0;
        domainCounts[q.domain] = 0;
      }
      domainScores[q.domain] += v;
      domainCounts[q.domain] += 1;
    });

    const domainAvgs = {};
    Object.keys(domainScores).forEach((key) => {
      domainAvgs[key] = domainScores[key] / domainCounts[key];
    });

    function toLevel(avg) {
      if (avg >= 3.25) return 'green';
      if (avg >= 2.25) return 'yellow';
      return 'red';
    }

    const domainLevels = {};
    Object.keys(domainAvgs).forEach((key) => {
      domainLevels[key] = toLevel(domainAvgs[key]);
    });

    const overallAvg = answers.reduce((a, b) => a + b, 0) / answers.length;
    const overallLevel = toLevel(overallAvg);

    return {
      resultType: grade === '34' ? 'overall' : 'byDomain',
      overallLevel,
      domainLevels: grade === '34' ? {} : domainLevels
    };
  }

  // 학생에게 보여줄 설명용 텍스트(숫자 없이)
  function buildStudentMessage(grade, levels) {
    const overall = levels.overallLevel;

    let msg = '';

    if (grade === '34') {
      if (overall === 'green') {
        msg += '요즘 나의 감정과 행동을 스스로 잘 살피고 조절하고 있어요. 지금처럼 나를 잘 돌보며 지내면 좋겠어요.';
      } else if (overall === 'yellow') {
        msg += '나를 이해하고 돌보려는 모습이 있지만, 상황에 따라 감정 조절이 어려울 때가 있을 수 있어요. 힘들 때 믿을 수 있는 어른에게 도움을 요청해 보세요.';
      } else {
        msg += '감정이 자주 요동치거나, 어떻게 표현해야 할지 막막할 수 있어요. 안전한 사람과 천천히 마음을 나누는 연습이 필요해요.';
      }
      return msg;
    }

    // 5–6학년: 역량별 신호등 간단 설명
    const labels = {
      selfAwareness: '자기 인식',
      selfManagement: '자기 관리',
      socialAwareness: '사회적 인식',
      relationshipSkills: '사회적 협력',
      responsibleDecision: '책임 있는 의사결정'
    };

    const strong = [];
    const need = [];

    Object.keys(labels).forEach((key) => {
      const lv = levels.domainLevels[key];
      if (!lv) return;
      if (lv === 'green') strong.push(labels[key]);
      else if (lv === 'yellow' || lv === 'red') need.push(labels[key]);
    });

    if (strong.length) {
      msg += `잘 하고 있는 부분: ${strong.join(', ')} 영역이에요. 이 강점을 계속 사용할 수 있으면 좋겠어요.\n`;
    }
    if (need.length) {
      msg += `더 연습하면 좋은 부분: ${need.join(', ')} 영역이에요. 수업 시간과 일상에서 조금씩 시도해 봅시다.`;
    }
    if (!msg) {
      // 혹시 도메인 정보가 비어 있을 때 대비
      if (overall === 'green') {
        msg += '사회정서 역량 전반이 안정적이에요. 지금처럼 나와 다른 사람을 함께 돌보면 좋겠어요.';
      } else if (overall === 'yellow') {
        msg += '대부분은 괜찮지만, 스트레스가 큰 상황에서는 흔들릴 수 있어요. 나에게 맞는 돌봄 방법을 함께 찾으면 좋겠어요.';
      } else {
        msg += '여러 부분에서 어려움이 느껴질 수 있어요. 혼자 감당하지 말고 믿을 수 있는 어른과 함께 방법을 찾아가 봅시다.';
      }
    }
    return msg;
  }

  function levelPill(level) {
    if (level === 'green') return '<span class="pill green">초록불</span>';
    if (level === 'yellow') return '<span class="pill yellow">노란불</span>';
    return '<span class="pill red">빨간불</span>';
  }

  // ------------------------
  // 4. 제출 버튼 핸들러
  // ------------------------
  document.getElementById('submitBtn').addEventListener('click', async () => {
    const grade = gradeSelect.value;
    const code = document.getElementById('studentCode').value.trim();

    if (!code) {
      alert('반/번호(코드)를 입력해 주세요.');
      return;
    }

    const questions = grade === '34' ? QUESTIONS_34 : QUESTIONS_56;
    const answers = [];

    for (const q of questions) {
      const selected = document.querySelector(`input[name="q${q.id}"]:checked`);
      if (!selected) {
        alert(`Q${q.id} 문항에 답해 주세요.`);
        return;
      }
      answers.push(Number(selected.value));
    }

    // 내부 계산 (숫자는 화면에 보여주지 않음)
    const levels = calcLevels(grade, answers, questions);

    // 결과 화면에 텍스트로만 보여주기
    const resultSection = document.getElementById('resultSection');
    const resultContent = document.getElementById('resultContent');

    let html = '';

    if (grade === '34') {
      html += `<p>나의 SEL 종합 신호등은 ${levelPill(levels.overallLevel)} 입니다.</p>`;
    } else {
      const labels = {
        selfAwareness: '자기 인식',
        selfManagement: '자기 관리',
        socialAwareness: '사회적 인식',
        relationshipSkills: '사회적 협력',
        responsibleDecision: '책임 있는 의사결정'
      };
      html += `<p>역량별 신호등입니다.</p>`;
      html += `<ul style="padding-left:18px; margin-top:4px; margin-bottom:6px; font-size:13px;">`;
      Object.keys(labels).forEach((key) => {
        const lv = levels.domainLevels[key];
        if (!lv) return;
        html += `<li>${labels[key]}: ${levelPill(lv)}</li>`;
      });
      html += `</ul>`;
    }

    html += `<p style="margin-top:8px; white-space:pre-line;">오늘을 돌아보는 한 문장<br><strong>${buildStudentMessage(grade, levels)}</strong></p>`;

    resultContent.innerHTML = html;
    resultSection.classList.remove('hidden');

    // 서버에 결과 저장 (점수 숫자는 서버 내부에서만 사용, 화면에는 안 나옴)
    try {
      await fetch('/api/sel/results', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          studentCode: code,
          gradeGroup: grade,
          answers,
          resultType: levels.resultType,
          overallLevel: levels.overallLevel,
          domainLevels: levels.domainLevels
        })
      });
    } catch (e) {
      console.error(e);
      // 저장 실패해도 학생에게는 조용히 넘어가도 됨
    }
  });

  // ------------------------
  // 5. 리셋 버튼
  // ------------------------
  document.getElementById('resetBtn').addEventListener('click', () => {
    renderQuestions();
    document.getElementById('resultSection').classList.add('hidden');
  });
</script>
</body>
</html>
